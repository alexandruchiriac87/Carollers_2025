// CONFIGURA»öIE DIN FI»òIER EXTERN
const ADMIN_PASSWORD = window.APP_CONFIG.ADMIN_PASSWORD;
const FIREBASE_CONFIG = window.APP_CONFIG.FIREBASE_CONFIG;
const ICONS = ['üéÑ', 'üéÖ', '‚≠ê', 'üîî', 'üéÅ', '‚ùÑÔ∏è', 'üïØÔ∏è', 'ü¶å', 'üß¶', 'üç™', 'ü§∂', '‚ú®'];

// Default center coordinates - Bucharest
const DEFAULT_CENTER = [44.47729443095744, 26.074460492097725];

let map;
let markers = [];
let pins = [];
let selectedIcon = 'üéÑ';
let clickedLocation = null;
let selectedPin = null;
let isConnected = false;
let userLocationMarker = null;
let isAdmin = false;
let visitedHouses = JSON.parse(localStorage.getItem('visitedHouses') || '{}');
let lastClickTime = 0;
let clickTimer = null;
let snowInterval = null;
let snowEnabled = true;
let visitorId = null;

document.addEventListener('DOMContentLoaded', init);

function init() {
    initMap();
    initIconGrid();
    setupEventListeners();
    initFirebase();
    initDateSelector();
    initTimeSelectors();
    setupNewFeatures();
    initVisitorCounter();
}

function setupNewFeatures() {
    initSnowflakes();
    initMusicControls();
    initSnowButton();
}

function initSnowflakes() {
    const snowContainer = document.getElementById('snow');
    snowEnabled = localStorage.getItem('carolers_snow') !== 'false';
    
    function createSnowflake() {
        if (!snowEnabled) return;
        
        const snowflake = document.createElement('div');
        snowflake.classList.add('snowflake');
        snowflake.style.left = Math.random() * 100 + 'vw';
        snowflake.style.animationDuration = (Math.random() * 3 + 2) + 's';
        snowflake.style.opacity = Math.random() * 0.7 + 0.3;
        snowflake.style.width = Math.random() * 8 + 4 + 'px';
        snowflake.style.height = snowflake.style.width;
        
        if (Math.random() > 0.7) {
            snowflake.style.background = 'rgba(200, 230, 255, 0.9)';
        }
        
        snowContainer.appendChild(snowflake);
        
        setTimeout(() => {
            if (snowflake.parentNode === snowContainer) {
                snowContainer.removeChild(snowflake);
            }
        }, 5000);
    }
    
    if (snowInterval) clearInterval(snowInterval);
    snowInterval = setInterval(createSnowflake, 150);
    
    if (snowEnabled) {
        for (let i = 0; i < 20; i++) {
            setTimeout(() => createSnowflake(), Math.random() * 1000);
        }
    }
}

function initSnowButton() {
    const snowBtn = document.getElementById('snow-btn');
    
    snowEnabled = localStorage.getItem('carolers_snow') !== 'false';
    
    if (snowEnabled) {
        snowBtn.textContent = '‚ùÑÔ∏è';
        snowBtn.classList.remove('snow-off');
        snowBtn.title = 'Turn off snow animation';
    } else {
        snowBtn.textContent = '‚ùÑÔ∏è';
        snowBtn.classList.add('snow-off');
        snowBtn.title = 'Turn on snow animation';
        document.getElementById('snow').innerHTML = '';
    }
    
    snowBtn.addEventListener('click', () => {
        snowEnabled = !snowEnabled;
        
        if (snowEnabled) {
            snowBtn.textContent = '‚ùÑÔ∏è';
            snowBtn.classList.remove('snow-off');
            snowBtn.title = 'Turn off snow animation';
            localStorage.setItem('carolers_snow', 'true');
            initSnowflakes();
            showToast("Snow animation enabled! ‚ùÑÔ∏è", "success");
        } else {
            snowBtn.textContent = '‚ùÑÔ∏è';
            snowBtn.classList.add('snow-off');
            snowBtn.title = 'Turn on snow animation';
            localStorage.setItem('carolers_snow', 'false');
            if (snowInterval) clearInterval(snowInterval);
            document.getElementById('snow').innerHTML = '';
            showToast("Snow animation disabled", "info");
        }
    });
}

function initMusicControls() {
    const musicBtn = document.getElementById('music-btn');
    const bgMusic = document.getElementById('bg-music');
    
    // VerificƒÉ preferin»õa utilizatorului
    const isMusicOn = localStorage.getItem('carolers_music') !== 'false';
    
    // SeteazƒÉ starea ini»õialƒÉ
    if (isMusicOn) {
        bgMusic.volume = 0.5;
        musicBtn.textContent = 'üîä';
        musicBtn.classList.add('music-playing');
        musicBtn.title = 'Turn off Christmas music';
        
        // √éncearcƒÉ sƒÉ porne»ôti muzica cu o √Ænt√¢rziere micƒÉ
        setTimeout(() => {
            bgMusic.play().catch(error => {
                console.log("Auto-play blocked:", error.name);
                // SchimbƒÉ butonul pentru a indica cƒÉ trebuie pornit manual
                musicBtn.textContent = '‚ñ∂Ô∏è';
                musicBtn.classList.remove('music-playing');
                musicBtn.title = 'Click to play music (autoplay blocked)';
                showToast("Click the music button to start Christmas music", "info");
            });
        }, 1000);
        
    } else {
        musicBtn.textContent = 'üîá';
        musicBtn.classList.remove('music-playing');
        musicBtn.title = 'Turn on Christmas music';
    }
    
    musicBtn.addEventListener('click', () => {
        if (bgMusic.paused) {
            bgMusic.volume = 0.5;
            bgMusic.play().then(() => {
                musicBtn.textContent = 'üîä';
                musicBtn.classList.add('music-playing');
                musicBtn.title = 'Turn off Christmas music';
                localStorage.setItem('carolers_music', 'true');
                showToast("Christmas music started! üé∂", "success");
            }).catch(error => {
                console.log("Play failed:", error);
                showToast("Click to play music manually", "info");
                musicBtn.textContent = '‚ñ∂Ô∏è';
                musicBtn.title = 'Click to play (requires interaction)';
            });
        } else {
            bgMusic.pause();
            musicBtn.textContent = 'üîá';
            musicBtn.classList.remove('music-playing');
            musicBtn.title = 'Turn on Christmas music';
            localStorage.setItem('carolers_music', 'false');
            showToast("Music paused", "info");
        }
    });
    
    // AdaugƒÉ un event listener pentru orice interac»õiune cu pagina
    document.addEventListener('click', function startMusicOnInteraction() {
        if (bgMusic.paused && localStorage.getItem('carolers_music') === 'true') {
            bgMusic.play().then(() => {
                musicBtn.textContent = 'üîä';
                musicBtn.classList.add('music-playing');
            }).catch(e => console.log("Play on interaction failed:", e));
        }
        // DupƒÉ prima interac»õiune, √ÆndepƒÉrteazƒÉ event listener-ul
        document.removeEventListener('click', startMusicOnInteraction);
    });
    
    // √éncearcƒÉ sƒÉ porne»ôti muzica c√¢nd se face scroll
    document.addEventListener('scroll', function startMusicOnScroll() {
        if (bgMusic.paused && localStorage.getItem('carolers_music') === 'true') {
            bgMusic.play().then(() => {
                musicBtn.textContent = 'üîä';
                musicBtn.classList.add('music-playing');
            }).catch(e => console.log("Play on scroll failed:", e));
        }
        document.removeEventListener('scroll', startMusicOnScroll);
    });
}

async function initVisitorCounter() {
    try {
        // GenereazƒÉ ID unic pentru visitor
        visitorId = localStorage.getItem('carolers_visitor_id');
        if (!visitorId) {
            visitorId = 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('carolers_visitor_id', visitorId);
        }
        
        // Ob»õine geoloca»õia mai detaliatƒÉ
        let geoData = {
            country: 'Unknown',
            city: 'Unknown',
            region: 'Unknown',
            countryCode: 'unknown',
            timezone: 'Unknown',
            languages: 'Unknown'
        };
        
        try {
            // √éncearcƒÉ mai multe API-uri pentru redundan»õƒÉ
            const geoResponse = await fetch('https://ipapi.co/json/');
            if (geoResponse.ok) {
                const geoJson = await geoResponse.json();
                geoData = {
                    country: geoJson.country_name || 'Unknown',
                    city: geoJson.city || 'Unknown',
                    region: geoJson.region || 'Unknown',
                    countryCode: geoJson.country_code || 'unknown',
                    timezone: geoJson.timezone || 'Unknown',
                    languages: geoJson.languages || 'Unknown',
                    latitude: geoJson.latitude,
                    longitude: geoJson.longitude,
                    org: geoJson.org || 'Unknown',
                    postal: geoJson.postal || 'Unknown'
                };
            }
        } catch (geoError) {
            console.log("Primary geolocation fetch failed:", geoError);
            
            // Fallback API
            try {
                const fallbackResponse = await fetch('https://ipinfo.io/json');
                if (fallbackResponse.ok) {
                    const fallbackJson = await fallbackResponse.json();
                    const loc = fallbackJson.loc ? fallbackJson.loc.split(',') : [null, null];
                    geoData = {
                        country: fallbackJson.country || 'Unknown',
                        city: fallbackJson.city || 'Unknown',
                        region: fallbackJson.region || 'Unknown',
                        countryCode: fallbackJson.country || 'unknown',
                        latitude: loc[0],
                        longitude: loc[1],
                        org: fallbackJson.org || 'Unknown',
                        postal: fallbackJson.postal || 'Unknown'
                    };
                }
            } catch (fallbackError) {
                console.log("Fallback geolocation fetch failed:", fallbackError);
            }
        }
        
        // ColecteazƒÉ informa»õii despre browser
        const browserInfo = {
            userAgent: navigator.userAgent.substring(0, 200),
            language: navigator.language,
            languages: navigator.languages ? navigator.languages.join(', ') : navigator.language,
            platform: navigator.platform,
            hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
            deviceMemory: navigator.deviceMemory || 'unknown',
            cookieEnabled: navigator.cookieEnabled,
            doNotTrack: navigator.doNotTrack || 'unknown',
            maxTouchPoints: navigator.maxTouchPoints || 0
        };
        
        if (isConnected) {
            const database = firebase.database();
            const visitorRef = database.ref('visitors/' + visitorId);
            
            const snapshot = await visitorRef.once('value');
            
            const visitorData = {
                id: visitorId,
                firstVisit: snapshot.exists() ? (snapshot.val().firstVisit || Date.now()) : Date.now(),
                lastVisit: Date.now(),
                visits: snapshot.exists() ? ((snapshot.val().visits || 1) + 1) : 1,
                timestamp: Date.now(),
                
                // Geolocation data
                country: geoData.country,
                city: geoData.city,
                region: geoData.region,
                countryCode: geoData.countryCode,
                timezone: geoData.timezone,
                languages: geoData.languages,
                latitude: geoData.latitude,
                longitude: geoData.longitude,
                org: geoData.org,
                postal: geoData.postal,
                
                // Browser/Device data
                ...browserInfo,
                
                // Page info
                referrer: document.referrer || 'direct',
                screenResolution: `${window.screen.width}x${window.screen.height}`,
                colorDepth: window.screen.colorDepth || 'unknown',
                pixelRatio: window.devicePixelRatio || 1
            };
            
            if (!snapshot.exists()) {
                await visitorRef.set(visitorData);
            } else {
                await visitorRef.update(visitorData);
            }
            
            // Ob»õine numƒÉrul total de vizitatori
            const allVisitorsRef = database.ref('visitors');
            const allVisitorsSnapshot = await allVisitorsRef.once('value');
            const totalVisitors = allVisitorsSnapshot.numChildren();
            
            document.getElementById('visitor-count').textContent = totalVisitors;
            
        } else {
            // Mod offline
            let totalVisitors = parseInt(localStorage.getItem('carolers_total_visitors') || '0');
            const visitorKey = 'visitor_' + visitorId;
            
            if (!localStorage.getItem(visitorKey)) {
                totalVisitors++;
                localStorage.setItem('carolers_total_visitors', totalVisitors.toString());
                localStorage.setItem(visitorKey, 'visited');
            }
            
            document.getElementById('visitor-count').textContent = totalVisitors;
        }
        
    } catch (error) {
        console.error('Error initializing visitor counter:', error);
        const fallbackCount = localStorage.getItem('carolers_visitor_count') || '1';
        document.getElementById('visitor-count').textContent = fallbackCount;
    }
}

async function showStatistics() {
    if (!isAdmin) {
        showError('You must be logged in as admin to view statistics!');
        showAdminLogin();
        return;
    }
    
    try {
        if (!isConnected) {
            showError('Statistics are only available when connected to the internet');
            return;
        }
        
        // Afi»ôeazƒÉ loading
        const statsBtn = document.getElementById('stats-btn');
        const originalText = statsBtn.innerHTML;
        statsBtn.innerHTML = 'üåç Loading...';
        statsBtn.disabled = true;
        
        const database = firebase.database();
        const visitorsRef = database.ref('visitors');
        const snapshot = await visitorsRef.once('value');
        
        const visitors = [];
        snapshot.forEach((child) => {
            visitors.push({
                id: child.key,
                ...child.val()
            });
        });
        
        // Reset buton
        statsBtn.innerHTML = originalText;
        statsBtn.disabled = false;
        
        if (visitors.length === 0) {
            showError('No visitor data available yet');
            return;
        }
        
        // CalculeazƒÉ statistici
        const countryStats = {};
        const cityStats = {};
        const dailyStats = {};
        
        visitors.forEach(visitor => {
            const country = visitor.country || 'Unknown';
            const city = visitor.city || 'Unknown';
            
            // Statistici pe »õƒÉri
            countryStats[country] = (countryStats[country] || 0) + 1;
            
            // Statistici pe ora»ôe (TOATE, nu doar top 10)
            if (city !== 'Unknown') {
                cityStats[city] = (cityStats[city] || 0) + 1;
            }
            
            // Statistici zilnice - corectat formatul datei
            const visitDate = new Date(visitor.lastVisit || visitor.timestamp || Date.now());
            // FormateazƒÉ data ca "Dec 25, 2024" pentru a evita confuzia lunƒÉ/zi
            const formattedDate = visitDate.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
            
            dailyStats[formattedDate] = (dailyStats[formattedDate] || 0) + 1;
        });
        
        // CreeazƒÉ HTML pentru statistici
        let statsHtml = `
            <div style="max-width: 500px; margin: 0 auto;">
                <div style="text-align: center; padding: 1rem; background: linear-gradient(135deg, #dc2626, #16a34a); color: white; border-radius: 0.75rem; margin-bottom: 1.5rem;">
                    <h3 style="margin-bottom: 0.5rem;">üåç Admin Statistics</h3>
                    <p style="opacity: 0.9;">Total unique visitors: <strong style="font-size: 1.5em;">${visitors.length}</strong></p>
                    <p style="opacity: 0.9; font-size: 0.875rem; margin-top: 0.5rem;">üìä Confidential data - Admin only</p>
                </div>
        `;
        
        // Statistici pe »õƒÉri - TOATE »õƒÉrile, sortate
        const sortedCountries = Object.entries(countryStats)
            .sort((a, b) => b[1] - a[1]);
        
        statsHtml += `
            <div class="stat-card">
                <h4 style="margin-bottom: 1rem; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.2em;">üìç</span>
                    All Countries (${sortedCountries.length})
                </h4>
                <div style="max-height: 300px; overflow-y: auto; padding-right: 5px;">
        `;
        
        sortedCountries.forEach(([country, count]) => {
            const percentage = (count / visitors.length * 100).toFixed(1);
            const barWidth = Math.min(100, (percentage * 1.5));
            
            // Ob»õine codul »õƒÉrii pentru steag
            const countryCode = getCountryCode(country);
            const flag = countryCode ? getFlagEmoji(countryCode) : 'üåê';
            
            statsHtml += `
                <div style="margin-bottom: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                        <span style="font-weight: 500; display: flex; align-items: center; gap: 8px;">
                            ${flag} ${country}
                        </span>
                        <span style="font-weight: 600; color: #dc2626;">${count} (${percentage}%)</span>
                    </div>
                    <div style="height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; background: linear-gradient(to right, #dc2626, #16a34a); width: ${barWidth}%; border-radius: 4px;"></div>
                    </div>
                </div>
            `;
        });
        
        statsHtml += `
                </div>
            </div>
        `;
        
        // Statistici pe ora»ôe - TOATE ora»ôele, sortate
        const sortedCities = Object.entries(cityStats)
            .sort((a, b) => b[1] - a[1]);
        
        if (sortedCities.length > 0) {
            statsHtml += `
                <div class="stat-card">
                    <h4 style="margin-bottom: 1rem; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.2em;">üèôÔ∏è</span>
                        All Cities (${sortedCities.length})
                    </h4>
                    <div style="max-height: 300px; overflow-y: auto;">
            `;
            
            sortedCities.forEach(([city, count]) => {
                const percentage = (count / visitors.length * 100).toFixed(1);
                
                statsHtml += `
                    <div style="display: flex; justify-content: space-between; padding: 0.75rem; border-bottom: 1px solid #e5e7eb; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.2em;">üèòÔ∏è</span>
                            <div>
                                <div style="font-weight: 500;">${city}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">${percentage}% of visitors</div>
                            </div>
                        </div>
                        <span style="font-weight: 600; background: #dcfce7; padding: 4px 8px; border-radius: 9999px; font-size: 0.875rem;">${count}</span>
                    </div>
                `;
            });
            
            statsHtml += `
                    </div>
                </div>
            `;
        }
        
        // Distribu»õie temporalƒÉ - ultimele 14 zile (pentru o vedere mai bunƒÉ)
        const sortedDates = Object.entries(dailyStats)
            .sort((a, b) => {
                // Sort by date properly
                const dateA = new Date(a[0]);
                const dateB = new Date(b[0]);
                return dateB - dateA; // Cele mai recente primele
            })
            .slice(0, 14); // Ultimele 14 zile
        
        if (sortedDates.length > 0) {
            // Sort for display (oldest to newest)
            const displayDates = [...sortedDates].reverse();
            
            statsHtml += `
                <div class="stat-card">
                    <h4 style="margin-bottom: 1rem; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.2em;">üìÖ</span>
                        Last 14 Days Activity
                    </h4>
                    <div style="display: flex; height: 200px; align-items: flex-end; gap: 4px; border-bottom: 1px solid #e5e7eb; padding-bottom: 30px;">
            `;
            
            const maxVisits = Math.max(...displayDates.map(([_, count]) => count));
            
            displayDates.forEach(([date, count]) => {
                const barHeight = maxVisits > 0 ? (count / maxVisits * 120) : 0;
                // FormateazƒÉ data pentru afi»ôare scurtƒÉ
                const dateObj = new Date(date);
                const shortDate = dateObj.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                statsHtml += `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%;">
                        <div style="flex: 1; display: flex; align-items: flex-end; width: 100%;">
                            <div 
                                style="
                                    width: 80%; 
                                    margin: 0 auto;
                                    background: linear-gradient(to top, #dc2626, #16a34a); 
                                    border-radius: 4px 4px 0 0;
                                    transition: all 0.3s ease;
                                    cursor: pointer;
                                "
                                title="${date}: ${count} visitors"
                                onmouseover="this.style.transform='scale(1.1)'; this.style.background='linear-gradient(to top, #ef4444, #22c55e)';"
                                onmouseout="this.style.transform='scale(1)'; this.style.background='linear-gradient(to top, #dc2626, #16a34a)';"
                                onclick="showDateDetails('${date}', ${count})"
                            >
                                <div style="height: ${barHeight}px;"></div>
                            </div>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.75rem; color: #6b7280; text-align: center;">
                            <div>${shortDate}</div>
                            <div style="font-weight: 600; color: #1f2937; margin-top: 2px;">${count}</div>
                        </div>
                    </div>
                `;
            });
            
            statsHtml += `
                    </div>
                    <div style="margin-top: 1rem; font-size: 0.75rem; color: #6b7280; text-align: center;">
                        Click on any bar to see details
                    </div>
                </div>
            `;
        }
        
        // Dispozitive/browsers (detaliere completƒÉ)
        const deviceStats = {
            'Mobile': 0,
            'Desktop': 0,
            'Tablet': 0
        };
        
        const browserStats = {};
        const osStats = {};
        
        visitors.forEach(visitor => {
            const ua = visitor.userAgent || navigator.userAgent;
            
            // Detect device
            if (/mobile/i.test(ua)) deviceStats['Mobile']++;
            else if (/tablet/i.test(ua)) deviceStats['Tablet']++;
            else deviceStats['Desktop']++;
            
            // Detect browser
            if (/chrome/i.test(ua) && !/edge/i.test(ua)) browserStats['Chrome'] = (browserStats['Chrome'] || 0) + 1;
            else if (/firefox/i.test(ua)) browserStats['Firefox'] = (browserStats['Firefox'] || 0) + 1;
            else if (/safari/i.test(ua) && !/chrome/i.test(ua)) browserStats['Safari'] = (browserStats['Safari'] || 0) + 1;
            else if (/edge/i.test(ua)) browserStats['Edge'] = (browserStats['Edge'] || 0) + 1;
            else if (/opera/i.test(ua)) browserStats['Opera'] = (browserStats['Opera'] || 0) + 1;
            else browserStats['Other'] = (browserStats['Other'] || 0) + 1;
            
            // Detect OS
            if (/windows/i.test(ua)) osStats['Windows'] = (osStats['Windows'] || 0) + 1;
            else if (/macintosh/i.test(ua) || /mac os/i.test(ua)) osStats['macOS'] = (osStats['macOS'] || 0) + 1;
            else if (/linux/i.test(ua)) osStats['Linux'] = (osStats['Linux'] || 0) + 1;
            else if (/android/i.test(ua)) osStats['Android'] = (osStats['Android'] || 0) + 1;
            else if (/iphone/i.test(ua) || /ipad/i.test(ua)) osStats['iOS'] = (osStats['iOS'] || 0) + 1;
            else osStats['Other'] = (osStats['Other'] || 0) + 1;
        });
        
        // Sort browser and OS stats
        const sortedBrowsers = Object.entries(browserStats).sort((a, b) => b[1] - a[1]);
        const sortedOS = Object.entries(osStats).sort((a, b) => b[1] - a[1]);
        
        statsHtml += `
            <div class="stat-card">
                <h4 style="margin-bottom: 1rem; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.2em;">üíª</span>
                    Devices & Browsers
                </h4>
                <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem;">
        `;
        
        // Device stats
        Object.entries(deviceStats).forEach(([device, count]) => {
            const percentage = (count / visitors.length * 100).toFixed(1);
            
            statsHtml += `
                <div style="flex: 1; min-width: 100px; text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.75rem;">
                    <div style="font-size: 2em; margin-bottom: 0.5rem;">${
                        device === 'Mobile' ? 'üì±' : 
                        device === 'Tablet' ? 'üìü' : 'üíª'
                    }</div>
                    <div style="font-weight: 600; margin-bottom: 0.25rem; color: #1f2937;">${device}</div>
                    <div style="font-size: 0.875rem; color: #6b7280;">${percentage}%</div>
                    <div style="font-size: 0.875rem; color: #dc2626; font-weight: 600; margin-top: 0.25rem;">${count}</div>
                </div>
            `;
        });
        
        statsHtml += `
                </div>
                
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                    <h5 style="margin-bottom: 0.75rem; color: #4b5563; display: flex; align-items: center; gap: 0.5rem;">
                        <span>üåê</span>
                        Browsers
                    </h5>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
        `;
        
        sortedBrowsers.forEach(([browser, count]) => {
            const percentage = (count / visitors.length * 100).toFixed(1);
            const icon = browser === 'Chrome' ? 'üü°' : 
                        browser === 'Firefox' ? 'ü¶ä' : 
                        browser === 'Safari' ? 'üîµ' : 
                        browser === 'Edge' ? 'üî∑' : 
                        browser === 'Opera' ? 'üî¥' : 'üåê';
            
            statsHtml += `
                <div style="flex: 1; min-width: 80px; text-align: center; padding: 0.75rem; background: #f1f5f9; border-radius: 0.5rem;">
                    <div style="font-size: 1.5em; margin-bottom: 0.25rem;">${icon}</div>
                    <div style="font-size: 0.75rem; font-weight: 500; color: #1f2937;">${browser}</div>
                    <div style="font-size: 0.7rem; color: #6b7280; margin-top: 2px;">${percentage}%</div>
                </div>
            `;
        });
        
        statsHtml += `
                    </div>
                </div>
                
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                    <h5 style="margin-bottom: 0.75rem; color: #4b5563; display: flex; align-items: center; gap: 0.5rem;">
                        <span>‚öôÔ∏è</span>
                        Operating Systems
                    </h5>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
        `;
        
        sortedOS.forEach(([os, count]) => {
            const percentage = (count / visitors.length * 100).toFixed(1);
            const icon = os === 'Windows' ? 'ü™ü' : 
                        os === 'macOS' ? 'üçé' : 
                        os === 'Linux' ? 'üêß' : 
                        os === 'Android' ? 'ü§ñ' : 
                        os === 'iOS' ? 'üì±' : 'üíª';
            
            statsHtml += `
                <div style="flex: 1; min-width: 80px; text-align: center; padding: 0.75rem; background: #f1f5f9; border-radius: 0.5rem;">
                    <div style="font-size: 1.5em; margin-bottom: 0.25rem;">${icon}</div>
                    <div style="font-size: 0.75rem; font-weight: 500; color: #1f2937;">${os}</div>
                    <div style="font-size: 0.7rem; color: #6b7280; margin-top: 2px;">${percentage}%</div>
                </div>
            `;
        });
        
        statsHtml += `
                    </div>
                </div>
            </div>
        `;
        
        // Informa»õii tehnice pentru admin
        const uniqueCountries = Object.keys(countryStats).filter(c => c !== 'Unknown').length;
        const uniqueCities = Object.keys(cityStats).filter(c => c !== 'Unknown').length;
        const totalVisits = visitors.reduce((sum, visitor) => sum + (visitor.visits || 1), 0);
        
        // GƒÉse»ôte cea mai popularƒÉ orƒÉ a zilei
        const hourStats = Array(24).fill(0);
        visitors.forEach(visitor => {
            const visitDate = new Date(visitor.lastVisit || visitor.timestamp || Date.now());
            const hour = visitDate.getHours();
            hourStats[hour] = (hourStats[hour] || 0) + 1;
        });
        
        const mostActiveHour = hourStats.indexOf(Math.max(...hourStats));
        
        statsHtml += `
            <div class="stat-card" style="background: #f0f9ff; border: 1px solid #0ea5e9;">
                <h4 style="margin-bottom: 1rem; color: #0369a1; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.2em;">üìà</span>
                    Technical Summary
                </h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #dc2626;">${uniqueCountries}</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">Unique Countries</div>
                    </div>
                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #16a34a;">${uniqueCities}</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">Unique Cities</div>
                    </div>
                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #8b5cf6;">${totalVisits}</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">Total Visits</div>
                    </div>
                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">${mostActiveHour}:00</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">Most Active Hour</div>
                    </div>
                </div>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 0.75rem; color: #6b7280;">First Visitor</div>
                            <div style="font-size: 0.875rem; font-weight: 500; color: #1f2937;">
                                ${new Date(Math.min(...visitors.map(v => v.firstVisit || v.timestamp || Date.now()))).toLocaleDateString()}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.75rem; color: #6b7280;">Last Updated</div>
                            <div style="font-size: 0.875rem; font-weight: 500; color: #1f2937;">
                                ${new Date().toLocaleString()}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        statsHtml += '</div>';
        
        // CreeazƒÉ un modal temporar pentru statistici
        const statsModal = document.createElement('div');
        statsModal.className = 'modal modal-view';
        statsModal.id = 'stats-modal';
        statsModal.style.maxWidth = '600px';
        statsModal.style.maxHeight = '85vh';
        statsModal.style.overflowY = 'auto';
        
        statsModal.innerHTML = `
            <div class="modal-header" style="position: sticky; top: 0; background: white; z-index: 1;">
                <h3 class="modal-title">
                    <span style="font-size: 1.5rem;">üåç</span>
                    Admin Statistics Dashboard
                </h3>
                <button class="close-btn" onclick="document.getElementById('stats-modal').remove(); document.getElementById('modal-overlay').classList.add('hidden');">√ó</button>
            </div>
            <div style="padding: 0 1.25rem 1.25rem;">
                ${statsHtml}
            </div>
        `;
        
        // AdaugƒÉ modalul la body
        document.body.appendChild(statsModal);
        document.getElementById('modal-overlay').classList.remove('hidden');
        
        // Anima»õie de intrare
        setTimeout(() => {
            statsModal.style.transform = 'translate(-50%, -50%) scale(1)';
            statsModal.style.opacity = '1';
        }, 10);
        
    } catch (error) {
        console.error('Error loading statistics:', error);
        showError('Could not load statistics: ' + error.message);
        
        // Reset buton √Æn caz de eroare
        const statsBtn = document.getElementById('stats-btn');
        if (statsBtn) {
            statsBtn.innerHTML = 'üåç Statistics';
            statsBtn.disabled = false;
        }
    }
}

// Func»õii helper pentru statistici
function getCountryCode(countryName) {
    // Map country names to country codes (simplified version)
    const countryMap = {
        'United States': 'US',
        'United Kingdom': 'GB',
        'Canada': 'CA',
        'Australia': 'AU',
        'Germany': 'DE',
        'France': 'FR',
        'Italy': 'IT',
        'Spain': 'ES',
        'Japan': 'JP',
        'China': 'CN',
        'India': 'IN',
        'Brazil': 'BR',
        'Mexico': 'MX',
        'Netherlands': 'NL',
        'Switzerland': 'CH',
        'Sweden': 'SE',
        'Norway': 'NO',
        'Denmark': 'DK',
        'Finland': 'FI',
        'Romania': 'RO',
        'Poland': 'PL',
        'Russia': 'RU',
        'Ukraine': 'UA',
        'Turkey': 'TR',
        'Greece': 'GR',
        'Portugal': 'PT',
        'Belgium': 'BE',
        'Austria': 'AT',
        'Ireland': 'IE',
        'New Zealand': 'NZ',
        'South Africa': 'ZA',
        'Egypt': 'EG',
        'Israel': 'IL',
        'Saudi Arabia': 'SA',
        'United Arab Emirates': 'AE',
        'Singapore': 'SG',
        'Malaysia': 'MY',
        'Indonesia': 'ID',
        'Thailand': 'TH',
        'Vietnam': 'VN',
        'Philippines': 'PH',
        'South Korea': 'KR',
        'Taiwan': 'TW',
        'Hong Kong': 'HK'
    };
    
    return countryMap[countryName] || null;
}

function getFlagEmoji(countryCode) {
    if (!countryCode) return 'üåê';
    
    try {
        // Convert country code to regional indicator symbols
        const codePoints = countryCode.toUpperCase().split('').map(char => 
            127397 + char.charCodeAt(0)
        );
        return String.fromCodePoint(...codePoints);
    } catch (e) {
        return 'üåê';
    }
}

function showDateDetails(date, count) {
    showToast(`üìÖ ${date}: ${count} visitors`, "info");
}

function initDateSelector() {
    const dateSelect = document.getElementById('schedule-date');
    dateSelect.innerHTML = '<option value="">-- Select date --</option>';
    
    const currentYear = new Date().getFullYear();
    const currentDate = new Date();
    
    for (let day = 1; day <= 31; day++) {
        const date = new Date(currentYear, 11, day);
        
        if (date >= currentDate || date.getDate() === currentDate.getDate()) {
            const formattedDate = date.toLocaleDateString('en-US', {
                day: 'numeric',
                month: 'short'
            });
            const option = document.createElement('option');
            option.value = formattedDate;
            option.textContent = formattedDate;
            dateSelect.appendChild(option);
        }
    }
}

function initTimeSelectors() {
    const hourSelectors = ['start-hour', 'end-hour'];
    hourSelectors.forEach(id => {
        const select = document.getElementById(id);
        select.innerHTML = '<option value="">Hour</option>';
        for (let hour = 0; hour < 24; hour++) {
            const option = document.createElement('option');
            option.value = hour.toString().padStart(2, '0');
            option.textContent = hour.toString().padStart(2, '0');
            select.appendChild(option);
        }
    });
    
    const minuteSelectors = ['start-minute', 'end-minute'];
    minuteSelectors.forEach(id => {
        const select = document.getElementById(id);
        select.innerHTML = '<option value="">Minute</option>';
        for (let minute = 0; minute < 60; minute += 5) {
            const option = document.createElement('option');
            option.value = minute.toString().padStart(2, '0');
            option.textContent = minute.toString().padStart(2, '0');
            select.appendChild(option);
        }
    });
    
    const timeSelectors = ['start-hour', 'start-minute', 'end-hour', 'end-minute', 'schedule-date'];
    timeSelectors.forEach(id => {
        document.getElementById(id).addEventListener('change', function() {
            updateScheduleDisplay();
            validateTimes();
        });
    });
}

function getSelectedTime(startOrEnd) {
    const hour = document.getElementById(`${startOrEnd}-hour`).value;
    const minute = document.getElementById(`${startOrEnd}-minute`).value;
    
    if (hour && minute) {
        return `${hour.padStart(2, '0')}:${minute.padStart(2, '0')}`;
    }
    return '';
}

function updateScheduleDisplay() {
    const date = document.getElementById('schedule-date').value;
    const startTime = getSelectedTime('start');
    const endTime = getSelectedTime('end');
    
    const display = document.getElementById('schedule-display');
    const scheduleText = document.getElementById('schedule-text');
    
    let scheduleString = '';
    
    if (date) {
        scheduleString += date;
        
        if (startTime && endTime) {
            scheduleString += `, ${startTime}-${endTime}`;
        } else if (startTime) {
            scheduleString += `, from ${startTime}`;
        } else if (endTime) {
            scheduleString += `, until ${endTime}`;
        }
    }
    
    if (scheduleString) {
        scheduleText.textContent = scheduleString;
        display.classList.remove('hidden');
    } else {
        display.classList.add('hidden');
    }
}

function getScheduleValue() {
    const date = document.getElementById('schedule-date').value;
    const startTime = getSelectedTime('start');
    const endTime = getSelectedTime('end');
    
    if (!date && !startTime && !endTime) {
        return '';
    }
    
    let scheduleString = '';
    
    if (date) {
        scheduleString += date;
    }
    
    if (startTime && endTime) {
        if (scheduleString) {
            scheduleString += `, ${startTime}-${endTime}`;
        } else {
            scheduleString = `${startTime}-${endTime}`;
        }
    } else if (startTime) {
        if (scheduleString) {
            scheduleString += `, from ${startTime}`;
        } else {
            scheduleString = `From ${startTime}`;
        }
    } else if (endTime) {
        if (scheduleString) {
            scheduleString += `, until ${endTime}`;
        } else {
            scheduleString = `Until ${endTime}`;
        }
    }
    
    return scheduleString;
}

function validateTimes() {
    const startTime = getSelectedTime('start');
    const endTime = getSelectedTime('end');
    
    if (startTime && endTime) {
        const startMinutes = timeToMinutes(startTime);
        const endMinutes = timeToMinutes(endTime);
        
        if (endMinutes <= startMinutes) {
            showError('End time must be after start time!');
            document.getElementById('end-hour').value = '';
            document.getElementById('end-minute').value = '';
            document.getElementById('schedule-display').classList.add('hidden');
            return false;
        }
    }
    return true;
}

function timeToMinutes(time) {
    const [hours, minutes] = time.split(':').map(Number);
    return hours * 60 + minutes;
}

function setupEventListeners() {
    document.getElementById('add-btn-right').addEventListener('click', openAddModal);
    document.getElementById('gps-btn').addEventListener('click', getUserLocation);
    document.getElementById('center-btn').addEventListener('click', centerToDefault);
    document.getElementById('share-btn-right').addEventListener('click', shareOnWhatsApp);
    document.getElementById('pin-count').addEventListener('click', showListModal);
    document.getElementById('info-btn').addEventListener('click', showInfoModal);
    document.getElementById('modal-overlay').addEventListener('click', closeAllModals);
}

function initFirebase() {
    try {
        if (typeof firebase === 'undefined') {
            console.error('Firebase SDK not loaded');
            isConnected = false;
            updateConnectionStatus();
            loadFromLocalStorage();
            return;
        }

        if (!firebase.apps.length) {
            firebase.initializeApp(FIREBASE_CONFIG);
            console.log('Firebase initialized successfully');
        } else {
            console.log('Firebase already initialized');
        }
        
        const database = firebase.database();
        
        const connectedRef = database.ref(".info/connected");
        connectedRef.on("value", function(snap) {
            const connected = snap.val() === true;
            console.log("Firebase connected:", connected);
            
            if (connected !== isConnected) {
                isConnected = connected;
                updateConnectionStatus();
                
                if (isConnected) {
                    loadPinsFromFirebase();
                    initVisitorCounter();
                }
            }
        });
        
    } catch (error) {
        console.error('Firebase initialization error:', error);
        isConnected = false;
        updateConnectionStatus();
        loadFromLocalStorage();
    }
}

function updateConnectionStatus() {
    const statusElement = document.getElementById('connection-status');
    
    if (isConnected) {
        statusElement.classList.add('connected');
    } else {
        statusElement.classList.remove('connected');
    }
}

function loadPinsFromFirebase() {
    try {
        const database = firebase.database();
        database.ref('pins').on('value', (snapshot) => {
            pins = [];
            if (snapshot.exists()) {
                snapshot.forEach((child) => {
                    pins.push({ 
                        id: child.key, 
                        ...child.val() 
                    });
                });
                console.log("Loaded pins from Firebase:", pins.length);
                
                localStorage.setItem('carolersPins', JSON.stringify(pins));
            } else {
                console.log("No data in Firebase");
                loadFromLocalStorage();
            }
            updateMap();
            updatePinCount();
        }, (error) => {
            console.error('Firebase read error:', error);
            loadFromLocalStorage();
        });
    } catch (error) {
        console.error('Error loading from Firebase:', error);
        loadFromLocalStorage();
    }
}

function loadFromLocalStorage() {
    const savedPins = localStorage.getItem('carolersPins');
    if (savedPins) {
        pins = JSON.parse(savedPins);
        console.log("Loaded pins from localStorage:", pins.length);
    } else {
        pins = [];
        console.log("No pins in localStorage");
    }
    updateMap();
    updatePinCount();
}

function updateMap() {
    markers.forEach(marker => marker.remove());
    markers = [];
    
    if (pins.length === 0) {
        return;
    }
    
    pins.forEach(pin => {
        const isVisited = visitedHouses[pin.id];
        const icon = pin.icon || 'üéÑ';
        
        const marker = L.marker([pin.lat, pin.lng], {
            icon: L.divIcon({
                html: `
                    <div class="${isVisited ? 'visited-marker' : ''}" style="font-size: 42px; filter: drop-shadow(0 3px 6px rgba(0,0,0,0.4)); transform: translateY(-5px); position: relative;">
                        ${icon}
                    </div>
                `,
                className: 'custom-marker',
                iconSize: [42, 42],
                iconAnchor: [21, 42]
            })
        }).addTo(map);
        
        let tooltipContent = `
            <div class="custom-tooltip">
                <div class="tooltip-family">
                    ${isVisited ? '‚úÖ ' : ''}${pin.icon || 'üéÑ'} ${pin.name}
                </div>
                <div class="tooltip-address">
                    üìç ${pin.address}, No. ${pin.streetNumber}
                </div>
        `;
        
        if (pin.schedule) {
            tooltipContent += `
                <div class="tooltip-schedule">
                    üïê ${pin.schedule}
                </div>
            `;
        }
        
        if (pin.notes) {
            tooltipContent += `
                <div class="tooltip-notes">
                    üìù ${pin.notes}
                </div>
            `;
        }
        
        tooltipContent += `</div>`;
        
        marker.bindTooltip(tooltipContent, {
            direction: 'top',
            offset: [0, -40],
            opacity: 0.95,
            className: 'custom-tooltip-container'
        });
        
        marker.on('click', (e) => {
            const currentTime = new Date().getTime();
            const timeDiff = currentTime - lastClickTime;
            
            if (timeDiff < 300 && timeDiff > 0) {
                clearTimeout(clickTimer);
                showDeleteModalForPin(pin);
            } else {
                clickTimer = setTimeout(() => {
                    toggleVisited(pin.id);
                }, 300);
            }
            
            lastClickTime = currentTime;
        });
        
        markers.push(marker);
    });
}

function showDeleteModalForPin(pin) {
    selectedPin = pin;
    document.getElementById('delete-house-info').textContent = 
        `${pin.icon || 'üéÑ'} ${pin.name} - ${pin.address}, No. ${pin.streetNumber}`;
    document.getElementById('delete-confirm-password').value = '';
    showModal('delete-confirm-modal');
}

function closeDeleteConfirmModal() {
    hideModal('delete-confirm-modal');
    selectedPin = null;
}

function confirmPinDelete() {
    if (!selectedPin) return;
    
    const password = document.getElementById('delete-confirm-password').value;
    
    if (!password) {
        showError('Please enter a password');
        return;
    }
    
    const isAdminUser = password === ADMIN_PASSWORD;
    const isOwner = selectedPin.password && password === selectedPin.password;
    
    if (!isAdminUser && !isOwner) {
        showError('Incorrect password');
        return;
    }
    
    try {
        if (isConnected) {
            const database = firebase.database();
            database.ref('pins/' + selectedPin.id).remove()
                .then(() => {
                    console.log("Pin deleted from Firebase");
                    closeDeleteConfirmModal();
                    loadPinsFromFirebase();
                })
                .catch((error) => {
                    showError('Error deleting from server: ' + error.message);
                });
        } else {
            pins = pins.filter(pin => pin.id !== selectedPin.id);
            localStorage.setItem('carolersPins', JSON.stringify(pins));
            updateMap();
            updatePinCount();
            closeDeleteConfirmModal();
            
            if (!document.getElementById('list-modal').classList.contains('hidden')) {
                showListModal();
            }
        }
    } catch (error) {
        showError('Error deleting house: ' + error.message);
    }
}

function updatePinCount() {
    const count = pins.length;
    const visitedCount = Object.keys(visitedHouses).length;
    const text = count === 1 ? 'house' : 'houses';
    document.getElementById('pin-count-main').textContent = `${count} ${text}`;
    document.getElementById('pin-count-visited').textContent = `${visitedCount} visited`;
}

function showError(message) {
    document.getElementById('error-text').textContent = message;
    document.getElementById('error-message').classList.remove('hidden');
}

function closeError() {
    document.getElementById('error-message').classList.add('hidden');
}

function openAddModal() {
    if (!clickedLocation) {
        showError('Please first select a location on the map or use the GPS button!');
        return;
    }
    showModal('add-modal');
}

function closeAddModal() {
    hideModal('add-modal');
    document.getElementById('add-form').reset();
    document.getElementById('error-message').classList.add('hidden');
    document.getElementById('location-success').classList.add('hidden');
    document.getElementById('schedule-display').classList.add('hidden');
    clickedLocation = null;
    selectedIcon = 'üéÑ';
    initIconGrid();
    
    if (window.tempMarker) {
        window.tempMarker.remove();
        window.tempMarker = null;
    }
}

function showModal(modalId) {
    document.getElementById(modalId).classList.remove('hidden');
    document.getElementById('modal-overlay').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function hideModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
    document.getElementById('modal-overlay').classList.add('hidden');
    document.body.style.overflow = '';
}

function closeAllModals() {
    hideModal('add-modal');
    hideModal('view-modal');
    hideModal('list-modal');
    hideModal('admin-login-modal');
    hideModal('delete-confirm-modal');
    hideModal('info-modal');
    // EliminƒÉ modalul de statistici dacƒÉ existƒÉ
    const statsModal = document.getElementById('stats-modal');
    if (statsModal) {
        statsModal.remove();
    }
    document.getElementById('modal-overlay').classList.add('hidden');
}

function toggleVisited(houseId) {
    if (visitedHouses[houseId]) {
        delete visitedHouses[houseId];
    } else {
        visitedHouses[houseId] = true;
    }
    
    localStorage.setItem('visitedHouses', JSON.stringify(visitedHouses));
    updateMap();
    updatePinCount();
    
    if (!document.getElementById('list-modal').classList.contains('hidden')) {
        showListModal();
    }
}

function resetAllVisited() {
    visitedHouses = {};
    localStorage.setItem('visitedHouses', JSON.stringify(visitedHouses));
    updateMap();
    updatePinCount();
    
    if (!document.getElementById('list-modal').classList.contains('hidden')) {
        showListModal();
    }
}

function showAdminLogin() {
    showModal('admin-login-modal');
}

function closeAdminLogin() {
    hideModal('admin-login-modal');
    document.getElementById('admin-password').value = '';
}

function verifyAdmin() {
    const password = document.getElementById('admin-password').value;
    
    if (password === ADMIN_PASSWORD) {
        isAdmin = true;
        closeAdminLogin();
        
        // Afi»ôeazƒÉ butonul pentru statistici
        document.getElementById('stats-btn').style.display = 'flex';
        
        updateMap();
        
        showToast("Admin login successful! üåç", "success");
    } else {
        showError('Incorrect admin password');
    }
}

function showListModal() {
    if (pins.length === 0) {
        const listContainer = document.getElementById('list-container');
        listContainer.innerHTML = '<div class="empty-list">No houses added yet</div>';
        showModal('list-modal');
        return;
    }
    
    const sortedPins = [...pins].sort((a, b) => {
        const addressCompare = a.address.localeCompare(b.address);
        if (addressCompare !== 0) return addressCompare;
        
        const numA = parseInt(a.streetNumber.replace(/\D/g, '')) || 0;
        const numB = parseInt(b.streetNumber.replace(/\D/g, '')) || 0;
        return numA - numB;
    });
    
    const listContainer = document.getElementById('list-container');
    listContainer.innerHTML = '';
    
    sortedPins.forEach(pin => {
        const isVisited = visitedHouses[pin.id];
        const listItem = document.createElement('div');
        listItem.className = `list-item ${isVisited ? 'visited' : ''}`;
        
        const adminControls = `
            <div class="checkbox-container">
                <div class="checkbox ${isVisited ? 'checked' : ''}" onclick="toggleVisited('${pin.id}')"></div>
                <span class="checkbox-label" onclick="toggleVisited('${pin.id}')">I caroled here</span>
            </div>
            <button class="delete-btn" onclick="showDeleteModalForPinFromList('${pin.id}')" style="margin-top: 8px; font-size: 11px; padding: 4px 8px;">
                üóëÔ∏è Delete
            </button>
        `;
        
        listItem.innerHTML = `
            <div class="list-icon">${isVisited ? '‚úÖ' : (pin.icon || 'üéÑ')}</div>
            <div class="list-details">
                <div class="list-family">${pin.name} ${isVisited ? '<span style="color: #059669; font-size: 12px;">(Visited)</span>' : ''}</div>
                <div class="list-address">${pin.address}, No. ${pin.streetNumber}</div>
                ${pin.schedule ? `<div class="list-schedule">üïê ${pin.schedule}</div>` : ''}
                ${pin.notes ? `<div class="list-notes">üìù ${pin.notes}</div>` : ''}
                ${adminControls}
            </div>
        `;
        listContainer.appendChild(listItem);
    });
    
    showModal('list-modal');
}

function showDeleteModalForPinFromList(houseId) {
    const pin = pins.find(p => p.id === houseId);
    if (pin) {
        showDeleteModalForPin(pin);
    } else {
        showListModal();
    }
}

function closeListModal() {
    hideModal('list-modal');
}

function handleSubmit(e) {
    e.preventDefault();
    
    closeError();
    
    const name = document.getElementById('name').value.trim();
    const address = document.getElementById('address').value.trim();
    const streetNumber = document.getElementById('streetNumber').value.trim();
    
    if (!name || !address || !streetNumber) {
        showError('Please complete all required fields:\n\n‚Ä¢ Family Name\n‚Ä¢ Street\n‚Ä¢ House Number');
        return;
    }
    
    if (!clickedLocation) {
        showError('Please select a location on the map!');
        return;
    }
    
    const selectedDate = document.getElementById('schedule-date').value;
    if (selectedDate) {
        const currentDate = new Date();
        const selectedDateStr = selectedDate + ' ' + currentDate.getFullYear();
        const selectedDateObj = new Date(selectedDateStr);
        
        if (selectedDateObj < currentDate && selectedDateObj.getDate() !== currentDate.getDate()) {
            showError('Cannot select past dates! Please select today or a future date.');
            return;
        }
    }
    
    const startTime = getSelectedTime('start');
    const endTime = getSelectedTime('end');
    
    if (startTime && endTime) {
        const startMinutes = timeToMinutes(startTime);
        const endMinutes = timeToMinutes(endTime);
        
        if (endMinutes <= startMinutes) {
            showError('End time must be after start time!');
            return;
        }
    }
    
    const pinData = {
        name,
        address,
        streetNumber,
        schedule: getScheduleValue(),
        notes: document.getElementById('notes').value,
        icon: selectedIcon,
        password: document.getElementById('password').value,
        lat: clickedLocation.lat,
        lng: clickedLocation.lng,
        timestamp: new Date().toISOString()
    };
    
    try {
        if (isConnected) {
            const database = firebase.database();
            database.ref('pins').push(pinData)
                .then((result) => {
                    console.log("Saved to Firebase with key:", result.key);
                    closeAddModal();
                    
                    if (window.tempMarker) {
                        window.tempMarker.remove();
                        window.tempMarker = null;
                    }
                })
                .catch((error) => {
                    console.error("Firebase save error:", error);
                    showError('Error saving to server: ' + error.message);
                });
        } else {
            const newPin = {
                id: 'local_' + Date.now(),
                ...pinData
            };
            pins.push(newPin);
            localStorage.setItem('carolersPins', JSON.stringify(pins));
            updateMap();
            updatePinCount();
            closeAddModal();
            
            if (window.tempMarker) {
                window.tempMarker.remove();
                window.tempMarker = null;
            }
        }
    } catch (error) {
        console.error("Save error:", error);
        showError('Error saving house: ' + error.message);
    }
}

function initMap() {
    map = L.map('map');
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);
    
    map.setView(DEFAULT_CENTER, 15);
    
    map.on('click', (e) => {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        clickedLocation = { lat, lng };
        
        if (window.tempMarker) {
            window.tempMarker.remove();
        }
        
        window.tempMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                html: '<div style="font-size: 48px; animation: pulse 1s infinite; filter: drop-shadow(0 3px 6px rgba(0,0,0,0.4));">üìç</div>',
                className: 'temp-marker',
                iconSize: [48, 48],
                iconAnchor: [24, 48]
            })
        }).addTo(map);
        
        if (!document.getElementById('add-modal').classList.contains('hidden')) {
            document.getElementById('location-success').classList.remove('hidden');
        }
    });
    
    setTimeout(() => {
        map.invalidateSize();
        document.getElementById('loading').classList.add('hidden');
    }, 500);
    
    window.addEventListener('resize', () => {
        setTimeout(() => {
            map.invalidateSize();
        }, 100);
    });
}

function initIconGrid() {
    const grid = document.getElementById('icon-grid');
    grid.innerHTML = '';
    ICONS.forEach(icon => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'icon-btn';
        btn.textContent = icon;
        btn.onclick = () => selectIcon(icon);
        if (icon === selectedIcon) btn.classList.add('selected');
        grid.appendChild(btn);
    });
}

function selectIcon(icon) {
    selectedIcon = icon;
    document.querySelectorAll('.icon-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.textContent === icon);
    });
}

function getUserLocation() {
    const gpsBtn = document.getElementById('gps-btn');
    gpsBtn.disabled = true;
    gpsBtn.classList.add('loading');
    gpsBtn.innerHTML = '‚è≥';
    
    if (!navigator.geolocation) {
        resetGpsButton();
        showError('Geolocation is not supported by your browser');
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            clickedLocation = { lat, lng };
            
            if (userLocationMarker) {
                userLocationMarker.remove();
            }
            
            userLocationMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    html: '<div style="font-size: 48px; animation: pulse 1s infinite; filter: drop-shadow(0 3px 6px rgba(0,0,0,0.4)); color: #3b82f6;">üìç</div>',
                    className: 'user-location-marker',
                    iconSize: [48, 48],
                    iconAnchor: [24, 48]
                })
            }).addTo(map);
            
            map.setView([lat, lng], 17);
            
            gpsBtn.innerHTML = 'üìç';
            setTimeout(resetGpsButton, 2000);
            
            if (!document.getElementById('add-modal').classList.contains('hidden')) {
                document.getElementById('location-success').classList.remove('hidden');
            }
        },
        function(error) {
            resetGpsButton();
            showError('Could not get your location. Please select manually on the map.');
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
        }
    );
}

function resetGpsButton() {
    const gpsBtn = document.getElementById('gps-btn');
    gpsBtn.disabled = false;
    gpsBtn.classList.remove('loading');
    gpsBtn.innerHTML = 'üìç';
}

function centerToDefault() {
    map.setView(DEFAULT_CENTER, 15);
}

function shareOnWhatsApp() {
    const text = 'üéÑ Welcome Carolers! üéÖ\n\nMap of houses that welcome carolers.\nAdd your house too: ' + window.location.href;
    
    if (navigator.share) {
        navigator.share({
            title: 'Carolers Map',
            text: text
        });
    } else {
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
        window.open(whatsappUrl, '_blank');
    }
}

function showInfoModal() {
    showModal('info-modal');
}

function closeInfoModal() {
    hideModal('info-modal');
}

function showToast(message, type = 'info') {
    const oldToasts = document.querySelectorAll('.toast');
    oldToasts.forEach(toast => toast.remove());
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
